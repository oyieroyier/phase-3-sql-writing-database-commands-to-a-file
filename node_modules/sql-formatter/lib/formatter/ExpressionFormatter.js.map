{"version":3,"file":"ExpressionFormatter.js","names":["ExpressionFormatter","cfg","params","layout","inline","nodes","index","length","formatNode","node","formatComments","leadingComments","formatNodeWithoutComments","trailingComments","type","NodeType","function_call","formatFunctionCall","array_subscript","formatArraySubscript","property_access","formatPropertyAccess","parenthesis","formatParenthesis","between_predicate","formatBetweenPredicate","clause","formatClause","set_operation","formatSetOperation","limit_clause","formatLimitClause","all_columns_asterisk","formatAllColumnsAsterisk","literal","formatLiteral","identifier","formatIdentifier","parameter","formatParameter","operator","formatOperator","comma","formatComma","line_comment","formatLineComment","block_comment","formatBlockComment","keyword","formatKeywordNode","withComments","name","add","showKw","array","text","object","WS","NO_SPACE","property","inlineLayout","formatInlineExpression","children","openParen","getLayoutItems","closeParen","SPACE","NEWLINE","isTabularStyle","INDENT","formatSubExpression","indentation","increaseBlockLevel","decreaseBlockLevel","between","expr1","showNonTabularKw","and","expr2","increaseTopLevel","decreaseTopLevel","offset","count","_node","get","language","denseOperators","fn","comments","forEach","com","test","precedingWhitespace","MANDATORY_NEWLINE","NO_NEWLINE","splitBlockComment","line","comment","split","map","replace","format","oldParamIndex","getPositionalParameterIndex","InlineLayout","expressionWidth","e","InlineLayoutError","setPositionalParameterIndex","undefined","tokenType","TokenType","RESERVED_JOIN","formatJoin","RESERVED_DEPENDENT_CLAUSE","formatDependentClause","AND","OR","XOR","formatLogicalOperator","RESERVED_KEYWORD","RESERVED_FUNCTION_NAME","RESERVED_PHRASE","formatKeyword","CASE","formatCaseStart","END","formatCaseEnd","Error","logicalOperatorNewline","formatMultilineBlockEnd","isTabularToken","toTabularFormat","indentStyle","keywordCase","equalizeWhitespace","raw","toLowerCase"],"sources":["../../src/formatter/ExpressionFormatter.ts"],"sourcesContent":["import { FormatOptions } from 'src/FormatOptions';\nimport { equalizeWhitespace } from 'src/utils';\n\nimport Params from 'src/formatter/Params';\nimport { isTabularStyle } from 'src/formatter/config';\nimport { TokenType } from 'src/lexer/token';\nimport {\n  AllColumnsAsteriskNode,\n  ArraySubscriptNode,\n  AstNode,\n  BetweenPredicateNode,\n  SetOperationNode,\n  ClauseNode,\n  FunctionCallNode,\n  LimitClauseNode,\n  NodeType,\n  ParenthesisNode,\n  LiteralNode,\n  IdentifierNode,\n  ParameterNode,\n  OperatorNode,\n  LineCommentNode,\n  BlockCommentNode,\n  CommaNode,\n  KeywordNode,\n  PropertyAccessNode,\n  CommentNode,\n} from 'src/parser/ast';\n\nimport Layout, { WS } from './Layout';\nimport toTabularFormat, { isTabularToken } from './tabularStyle';\nimport InlineLayout, { InlineLayoutError } from './InlineLayout';\n\ninterface ExpressionFormatterParams {\n  cfg: FormatOptions;\n  params: Params;\n  layout: Layout;\n  inline?: boolean;\n}\n\n/** Formats a generic SQL expression */\nexport default class ExpressionFormatter {\n  private cfg: FormatOptions;\n  private params: Params;\n  private layout: Layout;\n\n  private inline = false;\n  private nodes: AstNode[] = [];\n  private index = -1;\n\n  constructor({ cfg, params, layout, inline = false }: ExpressionFormatterParams) {\n    this.cfg = cfg;\n    this.inline = inline;\n    this.params = params;\n    this.layout = layout;\n  }\n\n  public format(nodes: AstNode[]): Layout {\n    this.nodes = nodes;\n\n    for (this.index = 0; this.index < this.nodes.length; this.index++) {\n      this.formatNode(this.nodes[this.index]);\n    }\n    return this.layout;\n  }\n\n  private formatNode(node: AstNode) {\n    this.formatComments(node.leadingComments);\n    this.formatNodeWithoutComments(node);\n    this.formatComments(node.trailingComments);\n  }\n\n  private formatNodeWithoutComments(node: AstNode) {\n    switch (node.type) {\n      case NodeType.function_call:\n        return this.formatFunctionCall(node);\n      case NodeType.array_subscript:\n        return this.formatArraySubscript(node);\n      case NodeType.property_access:\n        return this.formatPropertyAccess(node);\n      case NodeType.parenthesis:\n        return this.formatParenthesis(node);\n      case NodeType.between_predicate:\n        return this.formatBetweenPredicate(node);\n      case NodeType.clause:\n        return this.formatClause(node);\n      case NodeType.set_operation:\n        return this.formatSetOperation(node);\n      case NodeType.limit_clause:\n        return this.formatLimitClause(node);\n      case NodeType.all_columns_asterisk:\n        return this.formatAllColumnsAsterisk(node);\n      case NodeType.literal:\n        return this.formatLiteral(node);\n      case NodeType.identifier:\n        return this.formatIdentifier(node);\n      case NodeType.parameter:\n        return this.formatParameter(node);\n      case NodeType.operator:\n        return this.formatOperator(node);\n      case NodeType.comma:\n        return this.formatComma(node);\n      case NodeType.line_comment:\n        return this.formatLineComment(node);\n      case NodeType.block_comment:\n        return this.formatBlockComment(node);\n      case NodeType.keyword:\n        return this.formatKeywordNode(node);\n    }\n  }\n\n  private formatFunctionCall(node: FunctionCallNode) {\n    this.withComments(node.name, () => {\n      this.layout.add(this.showKw(node.name));\n    });\n    this.formatNode(node.parenthesis);\n  }\n\n  private formatArraySubscript(node: ArraySubscriptNode) {\n    this.withComments(node.array, () => {\n      this.layout.add(\n        node.array.type === NodeType.keyword ? this.showKw(node.array) : node.array.text\n      );\n    });\n    this.formatNode(node.parenthesis);\n  }\n\n  private formatPropertyAccess(node: PropertyAccessNode) {\n    this.formatNode(node.object);\n    this.layout.add(WS.NO_SPACE, '.');\n    this.formatNode(node.property);\n  }\n\n  private formatParenthesis(node: ParenthesisNode) {\n    const inlineLayout = this.formatInlineExpression(node.children);\n\n    if (inlineLayout) {\n      this.layout.add(node.openParen);\n      this.layout.add(...inlineLayout.getLayoutItems());\n      this.layout.add(WS.NO_SPACE, node.closeParen, WS.SPACE);\n    } else {\n      this.layout.add(node.openParen, WS.NEWLINE);\n\n      if (isTabularStyle(this.cfg)) {\n        this.layout.add(WS.INDENT);\n        this.layout = this.formatSubExpression(node.children);\n      } else {\n        this.layout.indentation.increaseBlockLevel();\n        this.layout.add(WS.INDENT);\n        this.layout = this.formatSubExpression(node.children);\n        this.layout.indentation.decreaseBlockLevel();\n      }\n\n      this.layout.add(WS.NEWLINE, WS.INDENT, node.closeParen, WS.SPACE);\n    }\n  }\n\n  private formatBetweenPredicate(node: BetweenPredicateNode) {\n    this.layout.add(this.showKw(node.between), WS.SPACE);\n    this.layout = this.formatSubExpression(node.expr1);\n    this.layout.add(WS.NO_SPACE, WS.SPACE, this.showNonTabularKw(node.and), WS.SPACE);\n    this.layout = this.formatSubExpression(node.expr2);\n    this.layout.add(WS.SPACE);\n  }\n\n  private formatClause(node: ClauseNode) {\n    if (isTabularStyle(this.cfg)) {\n      this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node.name), WS.SPACE);\n    } else {\n      this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node.name), WS.NEWLINE);\n    }\n    this.layout.indentation.increaseTopLevel();\n\n    if (!isTabularStyle(this.cfg)) {\n      this.layout.add(WS.INDENT);\n    }\n    this.layout = this.formatSubExpression(node.children);\n\n    this.layout.indentation.decreaseTopLevel();\n  }\n\n  private formatSetOperation(node: SetOperationNode) {\n    this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node.name), WS.NEWLINE);\n    this.layout.add(WS.INDENT);\n    this.layout = this.formatSubExpression(node.children);\n  }\n\n  private formatLimitClause(node: LimitClauseNode) {\n    this.withComments(node.name, () => {\n      this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node.name));\n    });\n    this.layout.indentation.increaseTopLevel();\n\n    if (isTabularStyle(this.cfg)) {\n      this.layout.add(WS.SPACE);\n    } else {\n      this.layout.add(WS.NEWLINE, WS.INDENT);\n    }\n\n    if (node.offset) {\n      this.layout = this.formatSubExpression(node.offset);\n      this.layout.add(WS.NO_SPACE, ',', WS.SPACE);\n      this.layout = this.formatSubExpression(node.count);\n    } else {\n      this.layout = this.formatSubExpression(node.count);\n    }\n    this.layout.indentation.decreaseTopLevel();\n  }\n\n  private formatAllColumnsAsterisk(_node: AllColumnsAsteriskNode) {\n    this.layout.add('*', WS.SPACE);\n  }\n\n  private formatLiteral(node: LiteralNode) {\n    this.layout.add(node.text, WS.SPACE);\n  }\n\n  private formatIdentifier(node: IdentifierNode) {\n    this.layout.add(node.text, WS.SPACE);\n  }\n\n  private formatParameter(node: ParameterNode) {\n    this.layout.add(this.params.get(node), WS.SPACE);\n  }\n\n  private formatOperator({ text }: OperatorNode) {\n    // special operator\n    if (text === ':') {\n      this.layout.add(WS.NO_SPACE, text, WS.SPACE);\n      return;\n    } else if (text === '::') {\n      this.layout.add(WS.NO_SPACE, text);\n      return;\n    }\n    // special case for PLSQL @ dblink syntax\n    else if (text === '@' && this.cfg.language === 'plsql') {\n      this.layout.add(WS.NO_SPACE, text);\n      return;\n    }\n\n    // other operators\n    if (this.cfg.denseOperators) {\n      this.layout.add(WS.NO_SPACE, text);\n    } else {\n      this.layout.add(text, WS.SPACE);\n    }\n  }\n\n  private formatComma(_node: CommaNode) {\n    if (!this.inline) {\n      this.layout.add(WS.NO_SPACE, ',', WS.NEWLINE, WS.INDENT);\n    } else {\n      this.layout.add(WS.NO_SPACE, ',', WS.SPACE);\n    }\n  }\n\n  private withComments(node: AstNode, fn: () => void) {\n    this.formatComments(node.leadingComments);\n    fn();\n    this.formatComments(node.trailingComments);\n  }\n\n  private formatComments(comments: CommentNode[] | undefined) {\n    if (!comments) {\n      return;\n    }\n    comments.forEach(com => {\n      if (com.type === NodeType.line_comment) {\n        this.formatLineComment(com);\n      } else {\n        this.formatBlockComment(com);\n      }\n    });\n  }\n\n  private formatLineComment(node: LineCommentNode) {\n    if (/\\n/.test(node.precedingWhitespace || '')) {\n      this.layout.add(WS.NEWLINE, WS.INDENT, node.text, WS.MANDATORY_NEWLINE, WS.INDENT);\n    } else {\n      this.layout.add(WS.NO_NEWLINE, WS.SPACE, node.text, WS.MANDATORY_NEWLINE, WS.INDENT);\n    }\n  }\n\n  private formatBlockComment(node: BlockCommentNode) {\n    this.splitBlockComment(node.text).forEach(line => {\n      this.layout.add(WS.NEWLINE, WS.INDENT, line);\n    });\n    this.layout.add(WS.NEWLINE, WS.INDENT);\n  }\n\n  // Breaks up block comment to multiple lines.\n  // For example this comment (dots representing leading whitespace):\n  //\n  //   ..../**\n  //   .....* Some description here\n  //   .....* and here too\n  //   .....*/\n  //\n  // gets broken to this array (note the leading single spaces):\n  //\n  //   [ '/**',\n  //     '.* Some description here',\n  //     '.* and here too',\n  //     '.*/' ]\n  //\n  private splitBlockComment(comment: string): string[] {\n    return comment.split(/\\n/).map(line => {\n      if (/^\\s*\\*/.test(line)) {\n        return ' ' + line.replace(/^\\s*/, '');\n      } else {\n        return line.replace(/^\\s*/, '');\n      }\n    });\n  }\n\n  private formatSubExpression(nodes: AstNode[]): Layout {\n    return new ExpressionFormatter({\n      cfg: this.cfg,\n      params: this.params,\n      layout: this.layout,\n      inline: this.inline,\n    }).format(nodes);\n  }\n\n  private formatInlineExpression(nodes: AstNode[]): Layout | undefined {\n    const oldParamIndex = this.params.getPositionalParameterIndex();\n    try {\n      return new ExpressionFormatter({\n        cfg: this.cfg,\n        params: this.params,\n        layout: new InlineLayout(this.cfg.expressionWidth),\n        inline: true,\n      }).format(nodes);\n    } catch (e) {\n      if (e instanceof InlineLayoutError) {\n        // While formatting, some of the positional parameters might have\n        // been consumed, which increased the current parameter index.\n        // We reset the index to an earlier state, so we can run the\n        // formatting again and re-consume these parameters in non-inline mode.\n        this.params.setPositionalParameterIndex(oldParamIndex);\n        return undefined;\n      } else {\n        // forward all unexpected errors\n        throw e;\n      }\n    }\n  }\n\n  private formatKeywordNode(node: KeywordNode): void {\n    switch (node.tokenType) {\n      case TokenType.RESERVED_JOIN:\n        return this.formatJoin(node);\n      case TokenType.RESERVED_DEPENDENT_CLAUSE:\n        return this.formatDependentClause(node);\n      case TokenType.AND:\n      case TokenType.OR:\n      case TokenType.XOR:\n        return this.formatLogicalOperator(node);\n      case TokenType.RESERVED_KEYWORD:\n      case TokenType.RESERVED_FUNCTION_NAME:\n      case TokenType.RESERVED_PHRASE:\n        return this.formatKeyword(node);\n      case TokenType.CASE:\n        return this.formatCaseStart(node);\n      case TokenType.END:\n        return this.formatCaseEnd(node);\n      default:\n        throw new Error(`Unexpected token type: ${node.tokenType}`);\n    }\n  }\n\n  private formatJoin(node: KeywordNode) {\n    if (isTabularStyle(this.cfg)) {\n      // in tabular style JOINs are at the same level as clauses\n      this.layout.indentation.decreaseTopLevel();\n      this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n      this.layout.indentation.increaseTopLevel();\n    } else {\n      this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n    }\n  }\n\n  private formatKeyword(node: KeywordNode) {\n    this.layout.add(this.showKw(node), WS.SPACE);\n  }\n\n  private formatDependentClause(node: KeywordNode) {\n    this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n  }\n\n  private formatLogicalOperator(node: KeywordNode) {\n    if (this.cfg.logicalOperatorNewline === 'before') {\n      if (isTabularStyle(this.cfg)) {\n        // In tabular style AND/OR is placed on the same level as clauses\n        this.layout.indentation.decreaseTopLevel();\n        this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n        this.layout.indentation.increaseTopLevel();\n      } else {\n        this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n      }\n    } else {\n      this.layout.add(this.showKw(node), WS.NEWLINE, WS.INDENT);\n    }\n  }\n\n  private formatCaseStart(node: KeywordNode) {\n    this.layout.indentation.increaseBlockLevel();\n    this.layout.add(this.showKw(node), WS.NEWLINE, WS.INDENT);\n  }\n\n  private formatCaseEnd(node: KeywordNode) {\n    this.formatMultilineBlockEnd(node);\n  }\n\n  private formatMultilineBlockEnd(node: KeywordNode) {\n    this.layout.indentation.decreaseBlockLevel();\n\n    this.layout.add(WS.NEWLINE, WS.INDENT, this.showKw(node), WS.SPACE);\n  }\n\n  private showKw(node: KeywordNode): string {\n    if (isTabularToken(node.tokenType)) {\n      return toTabularFormat(this.showNonTabularKw(node), this.cfg.indentStyle);\n    } else {\n      return this.showNonTabularKw(node);\n    }\n  }\n\n  // Like showKw(), but skips tabular formatting\n  private showNonTabularKw(node: KeywordNode): string {\n    switch (this.cfg.keywordCase) {\n      case 'preserve':\n        return equalizeWhitespace(node.raw);\n      case 'upper':\n        return node.text;\n      case 'lower':\n        return node.text.toLowerCase();\n    }\n  }\n}\n"],"mappings":"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"}